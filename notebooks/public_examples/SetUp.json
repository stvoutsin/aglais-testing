{
  "paragraphs": [
    {
      "text": "%md\n\n# Platform set-up following Spark restart \n\n(or to set up the platform environment in any new Spark context).\n\nProbably will be needed as part of the curated set of example notebooks if we advise Spark restarts as a pre-requisite to using the system.\n\nNotes and useful links:\n- SQL syntax: https://spark.apache.org/docs/3.0.0/sql-ref.html (undocumented at 2.4.7, so have to use more recent documentation - CAUTION do not navigate to other aspects of the API from here!) ",
      "user": "gaiauser",
      "dateUpdated": "2021-10-13T10:27:53+0000",
      "progress": 0,
      "config": {
        "tableHide": false,
        "editorSetting": {
          "language": "markdown",
          "editOnDblClick": true,
          "completionKey": "TAB",
          "completionSupport": false
        },
        "colWidth": 12,
        "editorMode": "ace/mode/markdown",
        "fontSize": 9,
        "editorHide": true,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1634120873147_1064084991",
      "id": "20210504-130917_57061499",
      "dateCreated": "2021-10-13T10:27:53+0000",
      "status": "READY",
      "focus": true,
      "$$hashKey": "object:7511"
    },
    {
      "title": "Catalogue structure definitions",
      "text": "%pyspark\n\n# schemas defined from WFAU MS SQL schema files, excluding the spatial indexing attributes (which are not included in the original CSVs distributed by the respective Data Centres of course)\n\nfrom pyspark.sql.types import *\n\ngaia_source_schema = StructType([\n    StructField('solution_id', LongType(), True),\n    StructField('designation', StringType(), True),\n    StructField('source_id', LongType(), True),\n    StructField('random_index', LongType(), True),\n    StructField('ref_epoch', FloatType(), True),\n    StructField('ra', DoubleType(), True),\n    StructField('ra_error', DoubleType(), True),\n    StructField('dec', DoubleType(), True),\n    StructField('dec_error', DoubleType(), True),\n    StructField('parallax', DoubleType(), True),\n    StructField('parallax_error', DoubleType(), True),\n    StructField('parallax_over_error', FloatType(), True),\n    StructField('pm', FloatType(), True),\n    StructField('pmra', DoubleType(), True),\n    StructField('pmra_error', FloatType(), True),\n    StructField('pmdec', DoubleType(), True),\n    StructField('pmdec_error', FloatType(), True),\n    StructField('ra_dec_corr', FloatType(), True),\n    StructField('ra_parallax_corr', FloatType(), True),\n    StructField('ra_pmra_corr', FloatType(), True),\n    StructField('ra_pmdec_corr', FloatType(), True),\n    StructField('dec_parallax_corr', FloatType(), True),\n    StructField('dec_pmra_corr', FloatType(), True),\n    StructField('dec_pmdec_corr', FloatType(), True),\n    StructField('parallax_pmra_corr', FloatType(), True),\n    StructField('parallax_pmdec_corr', FloatType(), True),\n    StructField('pmra_pmdec_corr', FloatType(), True),\n    StructField('astrometric_n_obs_al', ShortType(), True),\n    StructField('astrometric_n_obs_ac', ShortType(), True),\n    StructField('astrometric_n_good_obs_al', ShortType(), True),\n    StructField('astrometric_n_bad_obs_al', ShortType(), True),\n    StructField('astrometric_gof_al', FloatType(), True),\n    StructField('astrometric_chi2_al', FloatType(), True),\n    StructField('astrometric_excess_noise', FloatType(), True),\n    StructField('astrometric_excess_noise_sig', FloatType(), True),\n    StructField('astrometric_params_solved', ShortType(), True),\n    StructField('astrometric_primary_flag', BooleanType(), True),\n    StructField('nu_eff_used_in_astrometry', FloatType(), True),\n    StructField('pseudocolour', FloatType(), True),\n    StructField('pseudocolour_error', FloatType(), True),\n    StructField('ra_pseudocolour_corr', FloatType(), True),\n    StructField('dec_pseudocolour_corr', FloatType(), True),\n    StructField('parallax_pseudocolour_corr', FloatType(), True),\n    StructField('pmra_pseudocolour_corr', FloatType(), True),\n    StructField('pmdec_pseudocolour_corr', FloatType(), True),\n    StructField('astrometric_matched_transits', ShortType(), True),\n    StructField('visibility_periods_used', ShortType(), True),\n    StructField('astrometric_sigma5d_max', FloatType(), True),\n    StructField('matched_transits', ShortType(), True),\n    StructField('new_matched_transits', ShortType(), True),\n    StructField('matched_transits_removed', ShortType(), True),\n    StructField('ipd_gof_harmonic_amplitude', FloatType(), True),\n    StructField('ipd_gof_harmonic_phase', FloatType(), True),\n    StructField('ipd_frac_multi_peak', ShortType(), True),\n    StructField('ipd_frac_odd_win', ShortType(), True),\n    StructField('ruwe', FloatType(), True),\n    StructField('scan_direction_strength_k1', FloatType(), True),\n    StructField('scan_direction_strength_k2', FloatType(), True),\n    StructField('scan_direction_strength_k3', FloatType(), True),\n    StructField('scan_direction_strength_k4', FloatType(), True),\n    StructField('scan_direction_mean_k1', FloatType(), True),\n    StructField('scan_direction_mean_k2', FloatType(), True),\n    StructField('scan_direction_mean_k3', FloatType(), True),\n    StructField('scan_direction_mean_k4', FloatType(), True),\n    StructField('duplicated_source', BooleanType(), True),\n    StructField('phot_g_n_obs', ShortType(), True),\n    StructField('phot_g_mean_flux', DoubleType(), True),\n    StructField('phot_g_mean_flux_error', FloatType(), True),\n    StructField('phot_g_mean_flux_over_error', FloatType(), True),\n    StructField('phot_g_mean_mag', FloatType(), True),\n    StructField('phot_bp_n_obs', ShortType(), True),\n    StructField('phot_bp_mean_flux', DoubleType(), True),\n    StructField('phot_bp_mean_flux_error', FloatType(), True),\n    StructField('phot_bp_mean_flux_over_error', FloatType(), True),\n    StructField('phot_bp_mean_mag', FloatType(), True),\n    StructField('phot_rp_n_obs', ShortType(), True),\n    StructField('phot_rp_mean_flux', DoubleType(), True),\n    StructField('phot_rp_mean_flux_error', FloatType(), True),\n    StructField('phot_rp_mean_flux_over_error', FloatType(), True),\n    StructField('phot_rp_mean_mag', FloatType(), True),\n    StructField('phot_bp_n_contaminated_transits', ShortType(), True),\n    StructField('phot_bp_n_blended_transits', ShortType(), True),\n    StructField('phot_rp_n_contaminated_transits', ShortType(), True),\n    StructField('phot_rp_n_blended_transits', ShortType(), True),\n    StructField('phot_proc_mode', ShortType(), True),\n    StructField('phot_bp_rp_excess_factor', FloatType(), True),\n    StructField('bp_rp', FloatType(), True),\n    StructField('bp_g', FloatType(), True),\n    StructField('g_rp', FloatType(), True),\n    StructField('dr2_radial_velocity', FloatType(), True),\n    StructField('dr2_radial_velocity_error', FloatType(), True),\n    StructField('dr2_rv_nb_transits', ShortType(), True),\n    StructField('dr2_rv_template_teff', FloatType(), True),\n    StructField('dr2_rv_template_logg', FloatType(), True),\n    StructField('dr2_rv_template_fe_h', FloatType(), True),\n    StructField('l', DoubleType(), True),\n    StructField('b', DoubleType(), True),\n    StructField('ecl_lon', DoubleType(), True),\n    StructField('ecl_lat', DoubleType(), True),\n])\n\ntwomass_psc_schema = StructType([\n    StructField('ra', DoubleType(), True),\n    StructField('dec', DoubleType(), True),\n    StructField('err_maj', FloatType(), True),\n    StructField('err_min', FloatType(), True),\n    StructField('err_ang', ShortType(), True),\n    StructField('designation', StringType(), True),\n    StructField('j_m', FloatType(), True),\n    StructField('j_cmsig', FloatType(), True),\n    StructField('j_msigcom', FloatType(), True),\n    StructField('j_snr', FloatType(), True),\n    StructField('h_m', FloatType(), True),\n    StructField('h_cmsig', FloatType(), True),\n    StructField('h_msigcom', FloatType(), True),\n    StructField('h_snr', FloatType(), True),\n    StructField('k_m', FloatType(), True),\n    StructField('k_cmsig', FloatType(), True),\n    StructField('k_msigcom', FloatType(), True),\n    StructField('k_snr', FloatType(), True),\n    StructField('ph_qual', StringType(), True),\n    StructField('rd_flg', StringType(), True),\n    StructField('bl_flg', StringType(), True),\n    StructField('cc_flg', StringType(), True),\n    StructField('ndet', StringType(), True),\n    StructField('prox', FloatType(), True),\n    StructField('pxpa', ShortType(), True),\n    StructField('pxcntr', IntegerType(), True),\n    StructField('gal_contam', ShortType(), True),\n    StructField('mp_flg', ShortType(), True),\n    StructField('pts_key', IntegerType(), True),\n    StructField('hemis', StringType(), True),\n    StructField('date', DateType(), True),\n    StructField('scan', ShortType(), True),\n    StructField('glon', FloatType(), True),\n    StructField('glat', FloatType(), True),\n    StructField('x_scan', FloatType(), True),\n    StructField('jdate', DoubleType(), True),\n    StructField('j_psfchi', FloatType(), True),\n    StructField('h_psfchi', FloatType(), True),\n    StructField('k_psfchi', FloatType(), True),\n    StructField('j_m_stdap', FloatType(), True),\n    StructField('j_msig_stdap', FloatType(), True),\n    StructField('h_m_stdap', FloatType(), True),\n    StructField('h_msig_stdap', FloatType(), True),\n    StructField('k_m_stdap', FloatType(), True),\n    StructField('k_msig_stdap', FloatType(), True),\n    StructField('dist_edge_ns', IntegerType(), True),\n    StructField('dist_edge_ew', IntegerType(), True),\n    StructField('dist_edge_flg', StringType(), True),\n    StructField('dup_src', ShortType(), True),\n    StructField('use_src', ShortType(), True),\n    StructField('a', StringType(), True),\n    StructField('dist_opt', FloatType(), True),\n    StructField('phi_opt', ShortType(), True),\n    StructField('b_m_opt', FloatType(), True),\n    StructField('vr_m_opt', FloatType(), True),\n    StructField('nopt_mchs', ShortType(), True),\n    StructField('ext_key', IntegerType(), True),\n    StructField('scan_key', IntegerType(), True),\n    StructField('coadd_key', IntegerType(), True),\n    StructField('coadd', ShortType(), True),\n])\n\nallwise_sc_schema = StructType([\n    StructField('designation', StringType(), True),\n    StructField('ra', DoubleType(), True),\n    StructField('dec', DoubleType(), True),\n    StructField('sigra', DoubleType(), True),\n    StructField('sigdec', DoubleType(), True),\n    StructField('sigradec', DoubleType(), True),\n    StructField('glon', DoubleType(), True),\n    StructField('glat', DoubleType(), True),\n    StructField('elon', DoubleType(), True),\n    StructField('elat', DoubleType(), True),\n    StructField('wx', DoubleType(), True),\n    StructField('wy', DoubleType(), True),\n    StructField('cntr', LongType(), True),\n    StructField('src_id', StringType(), True),\n    StructField('coadd_id', StringType(), True),\n    StructField('src', IntegerType(), True),\n    StructField('w1mpro', DoubleType(), True),\n    StructField('w1sigmpro', DoubleType(), True),\n    StructField('w1snr', DoubleType(), True),\n    StructField('w1rchi2', FloatType(), True),\n    StructField('w2mpro', DoubleType(), True),\n    StructField('w2sigmpro', DoubleType(), True),\n    StructField('w2snr', DoubleType(), True),\n    StructField('w2rchi2', FloatType(), True),\n    StructField('w3mpro', DoubleType(), True),\n    StructField('w3sigmpro', DoubleType(), True),\n    StructField('w3snr', DoubleType(), True),\n    StructField('w3rchi2', FloatType(), True),\n    StructField('w4mpro', DoubleType(), True),\n    StructField('w4sigmpro', DoubleType(), True),\n    StructField('w4snr', DoubleType(), True),\n    StructField('w4rchi2', FloatType(), True),\n    StructField('rchi2', FloatType(), True),\n    StructField('nb', IntegerType(), True),\n    StructField('na', IntegerType(), True),\n    StructField('w1sat', DoubleType(), True),\n    StructField('w2sat', DoubleType(), True),\n    StructField('w3sat', DoubleType(), True),\n    StructField('w4sat', DoubleType(), True),\n    StructField('satnum', StringType(), True),\n    StructField('ra_pm', DoubleType(), True),\n    StructField('dec_pm', DoubleType(), True),\n    StructField('sigra_pm', DoubleType(), True),\n    StructField('sigdec_pm', DoubleType(), True),\n    StructField('sigradec_pm', DoubleType(), True),\n    StructField('pmra', IntegerType(), True),\n    StructField('sigpmra', IntegerType(), True),\n    StructField('pmdec', IntegerType(), True),\n    StructField('sigpmdec', IntegerType(), True),\n    StructField('w1rchi2_pm', FloatType(), True),\n    StructField('w2rchi2_pm', FloatType(), True),\n    StructField('w3rchi2_pm', FloatType(), True),\n    StructField('w4rchi2_pm', FloatType(), True),\n    StructField('rchi2_pm', FloatType(), True),\n    StructField('pmcode', StringType(), True),\n    StructField('cc_flags', StringType(), True),\n    StructField('rel', StringType(), True),\n    StructField('ext_flg', IntegerType(), True),\n    StructField('var_flg', StringType(), True),\n    StructField('ph_qual', StringType(), True),\n    StructField('det_bit', IntegerType(), True),\n    StructField('moon_lev', StringType(), True),\n    StructField('w1nm', IntegerType(), True),\n    StructField('w1m', IntegerType(), True),\n    StructField('w2nm', IntegerType(), True),\n    StructField('w2m', IntegerType(), True),\n    StructField('w3nm', IntegerType(), True),\n    StructField('w3m', IntegerType(), True),\n    StructField('w4nm', IntegerType(), True),\n    StructField('w4m', IntegerType(), True),\n    StructField('w1cov', DoubleType(), True),\n    StructField('w2cov', DoubleType(), True),\n    StructField('w3cov', DoubleType(), True),\n    StructField('w4cov', DoubleType(), True),\n    StructField('w1cc_map', IntegerType(), True),\n    StructField('w1cc_map_str', StringType(), True),\n    StructField('w2cc_map', IntegerType(), True),\n    StructField('w2cc_map_str', StringType(), True),\n    StructField('w3cc_map', IntegerType(), True),\n    StructField('w3cc_map_str', StringType(), True),\n    StructField('w4cc_map', IntegerType(), True),\n    StructField('w4cc_map_str', StringType(), True),\n    StructField('best_use_cntr', LongType(), True),\n    StructField('ngrp', ShortType(), True),\n    StructField('w1flux', FloatType(), True),\n    StructField('w1sigflux', FloatType(), True),\n    StructField('w1sky', DoubleType(), True),\n    StructField('w1sigsk', DoubleType(), True),\n    StructField('w1conf', DoubleType(), True),\n    StructField('w2flux', FloatType(), True),\n    StructField('w2sigflux', FloatType(), True),\n    StructField('w2sky', DoubleType(), True),\n    StructField('w2sigsk', DoubleType(), True),\n    StructField('w2conf', DoubleType(), True),\n    StructField('w3flux', FloatType(), True),\n    StructField('w3sigflux', FloatType(), True),\n    StructField('w3sky', DoubleType(), True),\n    StructField('w3sigsk', DoubleType(), True),\n    StructField('w3conf', DoubleType(), True),\n    StructField('w4flux', FloatType(), True),\n    StructField('w4sigflux', FloatType(), True),\n    StructField('w4sky', DoubleType(), True),\n    StructField('w4sigsk', DoubleType(), True),\n    StructField('w4conf', DoubleType(), True),\n    StructField('w1mag', DoubleType(), True),\n    StructField('w1sigm', DoubleType(), True),\n    StructField('w1flg', IntegerType(), True),\n    StructField('w1mcor', DoubleType(), True),\n    StructField('w2mag', DoubleType(), True),\n    StructField('w2sigm', DoubleType(), True),\n    StructField('w2flg', IntegerType(), True),\n    StructField('w2mcor', DoubleType(), True),\n    StructField('w3mag', DoubleType(), True),\n    StructField('w3sigm', DoubleType(), True),\n    StructField('w3flg', IntegerType(), True),\n    StructField('w3mcor', DoubleType(), True),\n    StructField('w4mag', DoubleType(), True),\n    StructField('w4sigm', DoubleType(), True),\n    StructField('w4flg', IntegerType(), True),\n    StructField('w4mcor', DoubleType(), True),\n    StructField('w1mag_1', DoubleType(), True),\n    StructField('w1sigm_1', DoubleType(), True),\n    StructField('w1flg_1', IntegerType(), True),\n    StructField('w2mag_1', DoubleType(), True),\n    StructField('w2sigm_1', DoubleType(), True),\n    StructField('w2flg_1', IntegerType(), True),\n    StructField('w3mag_1', DoubleType(), True),\n    StructField('w3sigm_1', DoubleType(), True),\n    StructField('w3flg_1', IntegerType(), True),\n    StructField('w4mag_1', DoubleType(), True),\n    StructField('w4sigm_1', DoubleType(), True),\n    StructField('w4flg_1', IntegerType(), True),\n    StructField('w1mag_2', DoubleType(), True),\n    StructField('w1sigm_2', DoubleType(), True),\n    StructField('w1flg_2', IntegerType(), True),\n    StructField('w2mag_2', DoubleType(), True),\n    StructField('w2sigm_2', DoubleType(), True),\n    StructField('w2flg_2', IntegerType(), True),\n    StructField('w3mag_2', DoubleType(), True),\n    StructField('w3sigm_2', DoubleType(), True),\n    StructField('w3flg_2', IntegerType(), True),\n    StructField('w4mag_2', DoubleType(), True),\n    StructField('w4sigm_2', DoubleType(), True),\n    StructField('w4flg_2', IntegerType(), True),\n    StructField('w1mag_3', DoubleType(), True),\n    StructField('w1sigm_3', DoubleType(), True),\n    StructField('w1flg_3', IntegerType(), True),\n    StructField('w2mag_3', DoubleType(), True),\n    StructField('w2sigm_3', DoubleType(), True),\n    StructField('w2flg_3', IntegerType(), True),\n    StructField('w3mag_3', DoubleType(), True),\n    StructField('w3sigm_3', DoubleType(), True),\n    StructField('w3flg_3', IntegerType(), True),\n    StructField('w4mag_3', DoubleType(), True),\n    StructField('w4sigm_3', DoubleType(), True),\n    StructField('w4flg_3', IntegerType(), True),\n    StructField('w1mag_4', DoubleType(), True),\n    StructField('w1sigm_4', DoubleType(), True),\n    StructField('w1flg_4', IntegerType(), True),\n    StructField('w2mag_4', DoubleType(), True),\n    StructField('w2sigm_4', DoubleType(), True),\n    StructField('w2flg_4', IntegerType(), True),\n    StructField('w3mag_4', DoubleType(), True),\n    StructField('w3sigm_4', DoubleType(), True),\n    StructField('w3flg_4', IntegerType(), True),\n    StructField('w4mag_4', DoubleType(), True),\n    StructField('w4sigm_4', DoubleType(), True),\n    StructField('w4flg_4', IntegerType(), True),\n    StructField('w1mag_5', DoubleType(), True),\n    StructField('w1sigm_5', DoubleType(), True),\n    StructField('w1flg_5', IntegerType(), True),\n    StructField('w2mag_5', DoubleType(), True),\n    StructField('w2sigm_5', DoubleType(), True),\n    StructField('w2flg_5', IntegerType(), True),\n    StructField('w3mag_5', DoubleType(), True),\n    StructField('w3sigm_5', DoubleType(), True),\n    StructField('w3flg_5', IntegerType(), True),\n    StructField('w4mag_5', DoubleType(), True),\n    StructField('w4sigm_5', DoubleType(), True),\n    StructField('w4flg_5', IntegerType(), True),\n    StructField('w1mag_6', DoubleType(), True),\n    StructField('w1sigm_6', DoubleType(), True),\n    StructField('w1flg_6', IntegerType(), True),\n    StructField('w2mag_6', DoubleType(), True),\n    StructField('w2sigm_6', DoubleType(), True),\n    StructField('w2flg_6', IntegerType(), True),\n    StructField('w3mag_6', DoubleType(), True),\n    StructField('w3sigm_6', DoubleType(), True),\n    StructField('w3flg_6', IntegerType(), True),\n    StructField('w4mag_6', DoubleType(), True),\n    StructField('w4sigm_6', DoubleType(), True),\n    StructField('w4flg_6', IntegerType(), True),\n    StructField('w1mag_7', DoubleType(), True),\n    StructField('w1sigm_7', DoubleType(), True),\n    StructField('w1flg_7', IntegerType(), True),\n    StructField('w2mag_7', DoubleType(), True),\n    StructField('w2sigm_7', DoubleType(), True),\n    StructField('w2flg_7', IntegerType(), True),\n    StructField('w3mag_7', DoubleType(), True),\n    StructField('w3sigm_7', DoubleType(), True),\n    StructField('w3flg_7', IntegerType(), True),\n    StructField('w4mag_7', DoubleType(), True),\n    StructField('w4sigm_7', DoubleType(), True),\n    StructField('w4flg_7', IntegerType(), True),\n    StructField('w1mag_8', DoubleType(), True),\n    StructField('w1sigm_8', DoubleType(), True),\n    StructField('w1flg_8', IntegerType(), True),\n    StructField('w2mag_8', DoubleType(), True),\n    StructField('w2sigm_8', DoubleType(), True),\n    StructField('w2flg_8', IntegerType(), True),\n    StructField('w3mag_8', DoubleType(), True),\n    StructField('w3sigm_8', DoubleType(), True),\n    StructField('w3flg_8', IntegerType(), True),\n    StructField('w4mag_8', DoubleType(), True),\n    StructField('w4sigm_8', DoubleType(), True),\n    StructField('w4flg_8', IntegerType(), True),\n    StructField('w1magp', DoubleType(), True),\n    StructField('w1sigp1', DoubleType(), True),\n    StructField('w1sigp2', DoubleType(), True),\n    StructField('w1k', DoubleType(), True),\n    StructField('w1ndf', IntegerType(), True),\n    StructField('w1mlq', DoubleType(), True),\n    StructField('w1mjdmin', DoubleType(), True),\n    StructField('w1mjdmax', DoubleType(), True),\n    StructField('w1mjdmean', DoubleType(), True),\n    StructField('w2magp', DoubleType(), True),\n    StructField('w2sigp1', DoubleType(), True),\n    StructField('w2sigp2', DoubleType(), True),\n    StructField('w2k', DoubleType(), True),\n    StructField('w2ndf', IntegerType(), True),\n    StructField('w2mlq', DoubleType(), True),\n    StructField('w2mjdmin', DoubleType(), True),\n    StructField('w2mjdmax', DoubleType(), True),\n    StructField('w2mjdmean', DoubleType(), True),\n    StructField('w3magp', DoubleType(), True),\n    StructField('w3sigp1', DoubleType(), True),\n    StructField('w3sigp2', DoubleType(), True),\n    StructField('w3k', DoubleType(), True),\n    StructField('w3ndf', IntegerType(), True),\n    StructField('w3mlq', DoubleType(), True),\n    StructField('w3mjdmin', DoubleType(), True),\n    StructField('w3mjdmax', DoubleType(), True),\n    StructField('w3mjdmean', DoubleType(), True),\n    StructField('w4magp', DoubleType(), True),\n    StructField('w4sigp1', DoubleType(), True),\n    StructField('w4sigp2', DoubleType(), True),\n    StructField('w4k', DoubleType(), True),\n    StructField('w4ndf', IntegerType(), True),\n    StructField('w4mlq', DoubleType(), True),\n    StructField('w4mjdmin', DoubleType(), True),\n    StructField('w4mjdmax', DoubleType(), True),\n    StructField('w4mjdmean', DoubleType(), True),\n    StructField('rho12', IntegerType(), True),\n    StructField('rho23', IntegerType(), True),\n    StructField('rho34', IntegerType(), True),\n    StructField('q12', IntegerType(), True),\n    StructField('q23', IntegerType(), True),\n    StructField('q34', IntegerType(), True),\n    StructField('xscprox', DoubleType(), True),\n    StructField('w1rsemi', DoubleType(), True),\n    StructField('w1ba', DoubleType(), True),\n    StructField('w1pa', DoubleType(), True),\n    StructField('w1gmag', DoubleType(), True),\n    StructField('w1gerr', DoubleType(), True),\n    StructField('w1gflg', IntegerType(), True),\n    StructField('w2rsemi', DoubleType(), True),\n    StructField('w2ba', DoubleType(), True),\n    StructField('w2pa', DoubleType(), True),\n    StructField('w2gmag', DoubleType(), True),\n    StructField('w2gerr', DoubleType(), True),\n    StructField('w2gflg', IntegerType(), True),\n    StructField('w3rsemi', DoubleType(), True),\n    StructField('w3ba', DoubleType(), True),\n    StructField('w3pa', DoubleType(), True),\n    StructField('w3gmag', DoubleType(), True),\n    StructField('w3gerr', DoubleType(), True),\n    StructField('w3gflg', IntegerType(), True),\n    StructField('w4rsemi', DoubleType(), True),\n    StructField('w4ba', DoubleType(), True),\n    StructField('w4pa', DoubleType(), True),\n    StructField('w4gmag', DoubleType(), True),\n    StructField('w4gerr', DoubleType(), True),\n    StructField('w4gflg', IntegerType(), True),\n    StructField('tmass_key', IntegerType(), True),\n    StructField('r_2mass', DoubleType(), True),\n    StructField('pa_2mass', DoubleType(), True),\n    StructField('n_2mass', IntegerType(), True),\n    StructField('j_m_2mass', DoubleType(), True),\n    StructField('j_msig_2mass', DoubleType(), True),\n    StructField('h_m_2mass', DoubleType(), True),\n    StructField('h_msig_2mass', DoubleType(), True),\n    StructField('k_m_2mass', DoubleType(), True),\n    StructField('k_msig_2mass', DoubleType(), True),\n    StructField('x', DoubleType(), True),\n    StructField('y', DoubleType(), True),\n    StructField('z', DoubleType(), True),\n    StructField('spt_ind', IntegerType(), True),\n    StructField('htm20', LongType(), True),\n    StructField('spare', BooleanType(), True)\n])\n# N.B. that last column is the easiest way to work around the IPAC files having a trailing \"|\" at the end of each record which is interpereted as another column... d'oh\n\npanstarrs_dr1_otmo_schema = StructType([\n    StructField('obj_id', LongType(), True),\n    StructField('projection_id', ShortType(), True),\n    StructField('sky_cell_id', ShortType(), True),\n    StructField('obj_info_flag', IntegerType(), True),\n    StructField('quality_flag', ShortType(), True),\n    StructField('ra_mean', DoubleType(), True),\n    StructField('dec_mean', DoubleType(), True),\n    StructField('ra_mean_err', FloatType(), True),\n    StructField('dec_mean_err', FloatType(), True),\n    StructField('epoch_mean', DoubleType(), True),\n    StructField('n_stack_detections', ShortType(), True),\n    StructField('n_detections', ShortType(), True),\n    StructField('ng', ShortType(), True),\n    StructField('nr', ShortType(), True),\n    StructField('ni', ShortType(), True),\n    StructField('nz', ShortType(), True),\n    StructField('ny', ShortType(), True),\n    StructField('g_qf_perfect', FloatType(), True),\n    StructField('g_mean_psf_mag', FloatType(), True),\n    StructField('g_mean_psf_mag_err', FloatType(), True),\n    StructField('g_mean_psf_mag_std', FloatType(), True),\n    StructField('g_mean_psf_mag_npt', ShortType(), True),\n    StructField('g_mean_psf_mag_min', FloatType(), True),\n    StructField('g_mean_psf_mag_max', FloatType(), True),\n    StructField('g_mean_kron_mag', FloatType(), True),\n    StructField('g_mean_kron_mag_err', FloatType(), True),\n    StructField('g_flags', IntegerType(), True),\n    StructField('r_qf_perfect', FloatType(), True),\n    StructField('r_mean_psf_mag', FloatType(), True),\n    StructField('r_mean_psf_mag_err', FloatType(), True),\n    StructField('r_mean_psf_mag_std', FloatType(), True),\n    StructField('r_mean_psf_mag_npt', ShortType(), True),\n    StructField('r_mean_psf_mag_min', FloatType(), True),\n    StructField('r_mean_psf_mag_max', FloatType(), True),\n    StructField('r_mean_kron_mag', FloatType(), True),\n    StructField('r_mean_kron_mag_err', FloatType(), True),\n    StructField('r_flags', IntegerType(), True),\n    StructField('i_qf_perfect', FloatType(), True),\n    StructField('i_mean_psf_mag', FloatType(), True),\n    StructField('i_mean_psf_mag_err', FloatType(), True),\n    StructField('i_mean_psf_mag_std', FloatType(), True),\n    StructField('i_mean_psf_mag_npt', ShortType(), True),\n    StructField('i_mean_psf_mag_min', FloatType(), True),\n    StructField('i_mean_psf_mag_max', FloatType(), True),\n    StructField('i_mean_kron_mag', FloatType(), True),\n    StructField('i_mean_kron_mag_err', FloatType(), True),\n    StructField('i_flags', IntegerType(), True),\n    StructField('z_qf_perfect', FloatType(), True),\n    StructField('z_mean_psf_mag', FloatType(), True),\n    StructField('z_mean_psf_mag_err', FloatType(), True),\n    StructField('z_mean_psf_mag_std', FloatType(), True),\n    StructField('z_mean_psf_mag_npt', ShortType(), True),\n    StructField('z_mean_psf_mag_min', FloatType(), True),\n    StructField('z_mean_psf_mag_max', FloatType(), True),\n    StructField('z_mean_kron_mag', FloatType(), True),\n    StructField('z_mean_kron_mag_err', FloatType(), True),\n    StructField('z_flags', IntegerType(), True),\n    StructField('y_qf_perfect', FloatType(), True),\n    StructField('y_mean_psf_mag', FloatType(), True),\n    StructField('y_mean_psf_mag_err', FloatType(), True),\n    StructField('y_mean_psf_mag_std', FloatType(), True),\n    StructField('y_mean_psf_mag_npt', ShortType(), True),\n    StructField('y_mean_psf_mag_min', FloatType(), True),\n    StructField('y_mean_psf_mag_max', FloatType(), True),\n    StructField('y_mean_kron_mag', FloatType(), True),\n    StructField('y_mean_kron_mag_err', FloatType(), True),\n    StructField('y_flags', IntegerType(), True),\n])\n\n\n# crossmatch table schemas:\n\n# PS1\npanstarrs1_best_neighbour_schema = StructType([\n    StructField('source_id', LongType(), True),\n    StructField('clean_panstarrs1_oid', LongType(), True),\n    StructField('original_ext_source_id', LongType(), True),\n    StructField('angular_distance', FloatType(), True),\n    StructField('number_of_neighbours', ByteType(), True),\n    StructField('number_of_mates', ByteType(), True),\n    StructField('xm_flag', ShortType(), True),\n])\n\n# ALLWISE:\nallwise_best_neighbour_schema = StructType([\n    StructField('source_id', LongType(), True),\n    StructField('original_ext_source_id', StringType(), True),\n    StructField('angular_distance', FloatType(), True),\n    StructField('xm_flag', ShortType(), True),\n    StructField('allwise_oid', IntegerType(), True),\n    StructField('number_of_neighbours', ByteType(), True),\n    StructField('number_of_mates', ByteType(), True),\n])\n\n# 2MASS:\ntmasspscxsc_best_neighbour_schema = StructType([\n    StructField('source_id', LongType(), True),\n    StructField('original_ext_source_id', StringType(), True),\n    StructField('angular_distance', FloatType(), True),\n    StructField('xm_flag', ShortType(), True),\n    StructField('clean_tmass_psc_xsc_oid', IntegerType(), True),\n    StructField('number_of_neighbours', ByteType(), True),\n    StructField('number_of_mates', ByteType(), True),\n])\n\n\n# sanity checks:\n#print (gaia_source_schema)\n\n",
      "user": "gaiauser",
      "dateUpdated": "2021-10-13T10:27:53+0000",
      "progress": 0,
      "config": {
        "tableHide": false,
        "editorSetting": {
          "language": "python",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "colWidth": 12,
        "editorMode": "ace/mode/python",
        "fontSize": 9,
        "editorHide": true,
        "title": true,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1634120873147_1999628470",
      "id": "20210504-131126_1544574772",
      "dateCreated": "2021-10-13T10:27:53+0000",
      "status": "READY",
      "$$hashKey": "object:7512"
    },
    {
      "title": "Utility function definitions",
      "text": "%pyspark\n\n# useful definitions\n\n# number of buckets for our platform\nNUM_BUCKETS = 2048\n\n# and to re-establish the resource in a new (or reset) spark context:\ndef reattachParquetFileResourceToSparkContext(table_name, file_path, *schema_structures):\n    \"\"\"\n    Creates a Spark (in-memory) meta-record for the table resource specified for querying \n    through the PySpark SQL API.\n    \n    Assumes that the table contains the Gaia source_id attribute and that the files have \n    been previously partitioned, bucketed and sorted on this field in parquet format\n    - see function saveToBinnedParquet().  If the table name specified already exists in the\n    catalogue IT WILL BE REMOVED (but the underlying data, assumed external, will remain).\n    \n    Parameters\n    ----------\n    table_name : str\n        The table name to be used as the identifier in SQL queries etc.\n    file_path : str\n        The full disk file system path name to the folder containing the parquet file set. \n    schema_structures : StructType\n        One or more schema structures expressed as a StructType object containing a list of\n        StructField(field_name : str, type : data_type : DataType(), nullable : boolean)\n    \"\"\"\n\n    # put in the columns and their data types ...\n    table_create_statement = \"CREATE TABLE `\" + table_name + \"` (\"\n    for schema_structure in schema_structures:\n        for field in schema_structure:\n            table_create_statement += \"`\" + field.name + \"` \" + field.dataType.simpleString() + \",\"\n    # ... zapping that extraneous comma at the end\n    table_create_statement = table_create_statement[:-1]\n        \n    # append the organisational details \n    table_create_statement += \") USING parquet OPTIONS (path '\" + file_path + \"') \"\n    table_create_statement += \"CLUSTERED BY (source_id) SORTED BY (source_id) INTO %d\"%(NUM_BUCKETS) + \" BUCKETS\"\n    \n    # sanity check\n    print(table_create_statement)\n    \n    # scrub any existing record - N.B. tables defined in this way are EXTERNAL, so this statement will not scrub\n    # the underlying file data set. Also if the table doesn't exist, this will silently do nothing (no exception\n    # will be thrown).\n    spark.sql(\"DROP TABLE IF EXISTS \" + table_name)\n    \n    # create the table resource\n    spark.sql(table_create_statement)\n",
      "user": "gaiauser",
      "dateUpdated": "2021-10-13T10:27:53+0000",
      "progress": 0,
      "config": {
        "editorSetting": {
          "language": "python",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "colWidth": 12,
        "editorMode": "ace/mode/python",
        "fontSize": 9,
        "editorHide": true,
        "title": true,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1634120873147_1435340003",
      "id": "20210504-131319_1186301617",
      "dateCreated": "2021-10-13T10:27:53+0000",
      "status": "READY",
      "$$hashKey": "object:7513"
    },
    {
      "title": "Set up the catalogues on the platform",
      "text": "%pyspark\n\n# database name to create\ndatabase = \"gaiaedr3\"\n\n# root data store path: TODO change this to the official one when established.\ndata_store = \"file:////data/gaia/GEDR3/\" # \"file:////user/nch/PARQUET/REPARTITIONED/\"\n\n# create the database and switch the current SQL database context to it (from default)\nspark.sql(\"create database \" + database)\nspark.sql(\"use \" + database)\n\n# create the tables against their corresponding file sets and schema\nreattachParquetFileResourceToSparkContext(\"gaia_source\", data_store + \"GEDR3_GAIASOURCE\", gaia_source_schema)\nreattachParquetFileResourceToSparkContext(\"gaia_source_tmasspsc_best_neighbours\", data_store + \"GEDR3_2MASSPSC_BEST_NEIGHBOURS\", tmasspscxsc_best_neighbour_schema, twomass_psc_schema)\nreattachParquetFileResourceToSparkContext(\"gaia_source_allwise_best_neighbours\", data_store + \"GEDR3_ALLWISE_BEST_NEIGHBOURS\", allwise_best_neighbour_schema, twomass_psc_schema)\nreattachParquetFileResourceToSparkContext(\"gaia_source_ps1_best_neighbours\", data_store + \"GEDR3_PS1_BEST_NEIGHBOURS\", panstarrs1_best_neighbour_schema, panstarrs_dr1_otmo_schema)\n\n\n\n",
      "user": "gaiauser",
      "dateUpdated": "2021-10-13T10:27:53+0000",
      "progress": 0,
      "config": {
        "editorSetting": {
          "language": "python",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "colWidth": 12,
        "editorMode": "ace/mode/python",
        "fontSize": 9,
        "editorHide": false,
        "title": true,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1634120873147_296102685",
      "id": "20210504-131439_625331903",
      "dateCreated": "2021-10-13T10:27:53+0000",
      "status": "READY",
      "$$hashKey": "object:7514"
    },
    {
      "title": "Show details of databases and tables",
      "text": "%pyspark\n\n# show the database(s) now available within the context\nspark.sql(\"show databases\").show()\n\n# show the contents of the catalogue store that has been set up\nspark.catalog.listTables()\n",
      "user": "gaiauser",
      "dateUpdated": "2021-10-13T10:27:53+0000",
      "progress": 0,
      "config": {
        "editorSetting": {
          "language": "python",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "colWidth": 12,
        "editorMode": "ace/mode/python",
        "fontSize": 9,
        "editorHide": true,
        "title": true,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1634120873147_1290503045",
      "id": "20210504-132955_1641890430",
      "dateCreated": "2021-10-13T10:27:53+0000",
      "status": "READY",
      "$$hashKey": "object:7515"
    },
    {
      "title": "Check location on disk for main catalogue table from metastore",
      "text": "%pyspark\n\nspark.sql('DESCRIBE EXTENDED gaia_source').show(300, truncate = False)\n",
      "user": "gaiauser",
      "dateUpdated": "2021-10-13T10:27:53+0000",
      "progress": 0,
      "config": {
        "editorSetting": {
          "language": "python",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "colWidth": 12,
        "editorMode": "ace/mode/python",
        "fontSize": 9,
        "title": true,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1634120873147_1670880930",
      "id": "20210504-141425_1480464936",
      "dateCreated": "2021-10-13T10:27:53+0000",
      "status": "READY",
      "$$hashKey": "object:7516"
    },
    {
      "text": "%pyspark\n",
      "user": "gaiauser",
      "dateUpdated": "2021-10-13T10:27:53+0000",
      "progress": 0,
      "config": {
        "editorSetting": {
          "language": "python",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "colWidth": 12,
        "editorMode": "ace/mode/python",
        "fontSize": 9,
        "results": {},
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "runtimeInfos": {},
      "progressUpdateIntervalMs": 500,
      "jobName": "paragraph_1634120873148_1849364987",
      "id": "20210521-084938_875368697",
      "dateCreated": "2021-10-13T10:27:53+0000",
      "status": "READY",
      "$$hashKey": "object:7517"
    }
  ],
  "name": "SetUp",
  "id": "2GJ6TE7RC",
  "defaultInterpreterGroup": "spark",
  "version": "0.10.0",
  "noteParams": {},
  "noteForms": {},
  "angularObjects": {},
  "config": {
    "isZeppelinNotebookCronEnable": false,
    "looknfeel": "default",
    "personalizedMode": "false"
  },
  "info": {},
  "path": "/AglaisPublicExamples/SetUp"
}
