{"paragraphs":[{"title":"Introduction","text":"%md\n\nThe science exploitation platform currently hosts the following data sets:\n\n* The Gaia EDR3 source catalogue (a direct mirror of gaiaedr3.gaia_source from the Gaia archive);\n* Best neighbour tables for PanSTARRS DR1, 2MASS PSC and ALLWISE (again, directly mirrored from the corresponding tables in the Gaia archive under the gaiaedr3 namespace) along with the original records from the 2MASS PSC and ALLWISE catalogues, and Object Thin / Object Mean columns from PanSTARRS DR1 (respectively 2MASS, ALLWISE and PS1 hereafter) where a best neighbour is available.\n\nThese are presented as SQL-queryable resources as demonstrated in the following cells. Click on the outward-pointing arrows in the top right of each cell to show the code; click on inward-pointing arrows to hide. Each cell can be run by pressing the play icon in the top-right; click on the cog icon to see other options, e.g. to clear current output. Note that the variant of SQL here is [PySpark SQL](https://spark.apache.org/docs/3.0.0/sql-ref.html), not ADQL.","user":"nch","dateUpdated":"2021-05-07T14:37:24+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false,"title":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1620391081326_-801361593","id":"20210507-123801_497865463","dateCreated":"2021-05-07T12:38:01+0000","dateStarted":"2021-05-07T14:37:24+0000","dateFinished":"2021-05-07T14:37:24+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:5177"},{"title":"Database and table details","text":"%pyspark\n\n# show the database(s) available within the context\nspark.sql(\"show databases\").show()\n\n# show the contents of the catalogue store that has been set up\nprint(\"Tables available:\")\nfor line in spark.catalog.listTables(): print (line)\n\n# show the first 20 records from the Gaia source catalogue\nprint(\"\\nFirst 20 entries in gaia_source:\")\nspark.sql(\"select * from gaia_source\").show()\n","user":"nch","dateUpdated":"2021-06-28T12:28:34+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":true,"title":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1620391476948_-131014806","id":"20210507-124436_282498395","dateCreated":"2021-05-07T12:44:36+0000","dateStarted":"2021-05-07T14:07:33+0000","dateFinished":"2021-05-07T14:07:34+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:5178"},{"title":"Description and links","text":"%md\n\n<br>\nThe database context is presently gaiaedr3 at start-up, so all that is needed to identify a table is the name (the first item in each record above) in queries. The column description for gaia_source is browsable within the Gaia archive ADQL search tree-view, and also [online](https://gea.esac.esa.int/archive/documentation/GEDR3/Gaia_archive/chap_datamodel/sec_dm_main_tables/ssec_dm_gaia_source.html), as are the [best neighbour table columns](https://gea.esac.esa.int/archive/documentation/GEDR3/Gaia_archive/chap_datamodel/sec_dm_crossmatches/). For the \"external\" catalogues the column sets can be browsed as follows (click on each to follow the links):\n\n* [2MASS PSC](https://old.ipac.caltech.edu/2mass/releases/allsky/doc/sec2_2a.html \"2MASS point-source catalogue column details\");\n* [ALLWISE](https://wise2.ipac.caltech.edu/docs/release/allwise/expsup/sec2_1a.html \"ALLWISE catalogue column details\");\n* [PS1 OTMO](https://outerspace.stsci.edu/display/PANSTARRS/PS1+MeanObjectView+table+fields \"PS1 DR1 object-thin object-mean catalogue column details\") (note that column names follow the Gaia archive convention of all lower-case with underscore separators rather than the original CamelCase).\n\nIt is important to note that the best neighbour tables should not be used as a proxy for the original external survey datasets: only those records that are the best neighbour to one or more Gaia sources are included here. If you wish to query and analyse one or other of those catalogues in isolation, this is not the facility to use! The phrase \"one or more\" is also noteworthy: because of the way the Gaia cross-matches have been derived any one external catalogue source can be the best neighbour to more than one Gaia source. Please consult the [Gaia cross-match documentation on-line](https://gea.esac.esa.int/archive/documentation/GEDR3/Catalogue_consolidation/chap_crossmatch/) to familiarise yourself with the details.\n\nNote also the syntax in the last query above. At first sight this might look insanely profligate, especially if you are familiar with existing relational systems serving Gaia data via ADQL/TAP. On this Spark platform the execution engine works rather differently: a \"lazy\" execution plan is assembled from the workflow as notebook statements and cells are \"played\" through this interface - nothing actually happens until absolutely necessary. So the select statement is not executed: rather an optimised plan is created from the combination of the query as couched in SQL here, and the \".show()\" action. The latter is short-hand for displaying the first 20 entries only, and this is factored into the execution resulting in fast turn-around and a quick look at the underlying data resource. In general, all filters and other optimisations are \"pushed down\" through the execution plan at the last possible moment (when data are required to be collected from the distributed workers to the master executor in order to action an operation). This is discussed further in other example notebooks.\n\nColumn details can also be examined within the notebook by defining a data frame object against any table then echoing the schema; subsequent cells demonstrate some simple queries: \n","user":"nch","dateUpdated":"2021-06-28T12:24:15+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false,"title":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1620391578816_-364487324","id":"20210507-124618_1845823957","dateCreated":"2021-05-07T12:46:18+0000","dateStarted":"2021-05-07T15:10:22+0000","dateFinished":"2021-05-07T15:10:22+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:5179"},{"title":"Column listing for a table","text":"%pyspark\n\n# define a data frame object on a table:\ndf = spark.sql(\"select * from gaia_source_ps1_best_neighbours\")\n\n# display the schema with a touch of friendly formatting:\nprint(\"Column details of gaia_source_ps1_best_neighbours:\\n\")\nfor field in df.schema: print(\"%30s : %10s\"%(field.name, field.dataType.simpleString()))\n","user":"nch","dateUpdated":"2021-06-28T12:29:04+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":true,"title":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1620394724581_-301949996","id":"20210507-133844_1243154051","dateCreated":"2021-05-07T13:38:44+0000","dateStarted":"2021-05-07T14:16:17+0000","dateFinished":"2021-05-07T14:16:17+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:5180"},{"title":"Querying the main catalogue","text":"%pyspark\n\n# querying the main catalogue table is as simple as forming an SQL query:\ndf = spark.sql(\"select source_id, ra, dec, phot_g_mean_mag AS G from gaia_source\")\n\ndf.show()\n\n","user":"nch","dateUpdated":"2021-06-28T12:29:14+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true,"editorHide":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1620396501292_-294212058","id":"20210507-140821_1444471628","dateCreated":"2021-05-07T14:08:21+0000","dateStarted":"2021-05-07T14:46:12+0000","dateFinished":"2021-05-07T14:46:13+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:5181"},{"title":"Querying with cross-matched data","text":"%pyspark\n\n# a simple SQL join on Gaia source_id can be used to pull in external catalogue data with Gaia data via the pre-computed best-neighbour joins:\n#query = \"SELECT g.source_id, ra, dec, phot_g_mean_mag AS G, g_mean_psf_mag AS g_ps1, r_mean_psf_mag AS r_ps1\" + \\\n    #\" FROM gaia_source AS g INNER JOIN gaia_source_ps1_best_neighbours AS p ON g.source_id = p.source_id\"\n\nquery= \"SELECT gaia.source_id, gaia.ra, gaia.dec, gaia.phot_g_mean_mag AS gaia_g, ps1.g_mean_psf_mag AS ps1_g, ps1.r_mean_psf_mag AS ps1_r FROM gaia_source AS gaia INNER JOIN gaia_source_ps1_best_neighbours AS ps1 ON gaia.source_id = ps1.source_id\"\n\n# define a data frame object on this query\ndf = spark.sql(query)\n\n# echo first 20 records of the results set\ndf.show()\n","user":"zrq","dateUpdated":"2021-07-14T06:17:51+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1620398577884_-934769791","id":"20210507-144257_1004220319","dateCreated":"2021-05-07T14:42:57+0000","dateStarted":"2021-07-14T06:17:51+0000","dateFinished":"2021-07-14T06:17:54+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:5182"},{"title":"Things to note","text":"%md\n\n* although SQL-based, the API is much richer than SQL/ADQL in terms of programmability and flexibility in column types - this will become increasingly important in future data releases.\n* the are no ADQL geometric functions to limit spatially selections - the platform is designed primarily for large-scale statistical analyses and does not replicate all features of existing relational systems, especially those needed to delimit row sets to small sub-samples.\n* ...\n\n\n\n","user":"nch","dateUpdated":"2021-05-07T15:02:08+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"editorMode":"ace/mode/markdown","title":true,"editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1620398848450_1041237528","id":"20210507-144728_1143294166","dateCreated":"2021-05-07T14:47:28+0000","dateStarted":"2021-05-07T15:02:08+0000","dateFinished":"2021-05-07T15:02:08+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:5183"},{"text":"%md\n","user":"nch","dateUpdated":"2021-05-07T14:49:34+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"editorMode":"ace/mode/markdown"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1620398974935_-2078085461","id":"20210507-144934_423944230","dateCreated":"2021-05-07T14:49:34+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:5184"}],"name":"AglaisPublicExamples/Data holdings","id":"2G7W1D2EM","noteParams":{},"noteForms":{},"angularObjects":{"md:shared_process":[],"sh:shared_process":[],"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}